<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯Œé‚¦æ‚å°‡è¯åé…’ P&L çµ‚æ¥µç‰ˆ</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2580/2580552.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-spinner::-webkit-outer-spin-button, .no-spinner::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .no-spinner { -moz-appearance: textfield; }
        /* Lock Screen Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 selection:bg-blue-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;
        const { createPortal } = ReactDOM;

        // --- Icons ---
        const IconBase = ({ children, className, size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Calculator = (props) => <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="8" x2="16" y1="18" y2="18"/><path d="M16 14h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/></IconBase>;
        const DollarSign = (props) => <IconBase {...props}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>;
        const Package = (props) => <IconBase {...props}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const Wallet = (props) => <IconBase {...props}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Percent = (props) => <IconBase {...props}><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3 4 6 1 7 4 8 5 11 6 8 9 7 6 6 5 3Z"/></IconBase>;
        const ArrowDownToLine = (props) => <IconBase {...props}><path d="M12 17V3"/><path d="m6 11 6 6 6-6"/><path d="M19 21H5"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const PieChart = (props) => <IconBase {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;
        const Lock = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconBase>;
        const Unlock = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></IconBase>;

        // --- Components ---
        const Tooltip = ({ title, children, items = [], formula = "", note = "", highlight = false }) => {
            const [isVisible, setIsVisible] = useState(false);
            const [layout, setLayout] = useState({ top: 0, left: 0, arrowLeft: 0, placement: 'top' });
            const triggerRef = useRef(null);

            const calculatePosition = () => {
                if (triggerRef.current) {
                    const rect = triggerRef.current.getBoundingClientRect();
                    const tooltipWidth = 240; const tooltipHeight = 280; const gap = 12; const screenPadding = 16;
                    let top, placement;
                    if (rect.top < tooltipHeight + 50) { placement = 'bottom'; top = rect.bottom + gap; } else { placement = 'top'; top = rect.top - gap; }
                    const windowWidth = document.documentElement.clientWidth;
                    const triggerCenter = rect.left + (rect.width / 2);
                    let boxLeft = triggerCenter - (tooltipWidth / 2);
                    if (boxLeft < screenPadding) { boxLeft = screenPadding; } else if (boxLeft + tooltipWidth > windowWidth - screenPadding) { boxLeft = windowWidth - tooltipWidth - screenPadding; }
                    let arrowLeft = triggerCenter - boxLeft;
                    if (arrowLeft < 16) arrowLeft = 16; if (arrowLeft > tooltipWidth - 16) arrowLeft = tooltipWidth - 16;
                    setLayout({ top: Math.round(top + window.scrollY), left: Math.round(boxLeft + window.scrollX), arrowLeft: Math.round(arrowLeft), placement });
                }
            };
            const handleMouseEnter = () => { calculatePosition(); setIsVisible(true); };
            useEffect(() => {
                if (!isVisible) return;
                const handleScroll = () => calculatePosition();
                window.addEventListener('scroll', handleScroll, true);
                window.addEventListener('resize', handleScroll, true);
                return () => { window.removeEventListener('scroll', handleScroll, true); window.removeEventListener('resize', handleScroll, true); };
            }, [isVisible]);

            const tooltipContent = (
                <div className="absolute z-[9999] pointer-events-none w-[240px] transition-opacity duration-200 left-0 top-0" style={{ transform: `translate3d(${layout.left}px, ${layout.top}px, 0) translateY(${layout.placement === 'top' ? '-100%' : '0'})` }}>
                    <div className="bg-slate-900 text-white p-3 rounded-lg shadow-2xl text-left ring-1 ring-white/20 relative">
                        {title && <div className="font-bold border-b border-slate-700 pb-2 mb-2 text-sm text-yellow-400">{title}</div>}
                        {items.length > 0 && (<div className="space-y-2 mb-3">{items.map((item, idx) => (<div key={idx} className="flex justify-between text-xs items-center leading-normal"><span className="text-slate-300 mr-2 shrink-0">{item.label}:</span><span className={`font-mono text-right break-all ${item.isTotal ? 'font-bold text-white text-sm' : 'text-slate-200'}`}>{item.value}</span></div>))}</div>)}
                        {formula && (<div className="text-[10px] text-slate-300 border-t border-slate-700 pt-2 mt-2 leading-relaxed font-mono bg-slate-800/50 p-2 rounded"><span className="text-slate-500 block mb-1 font-sans font-bold text-[9px] uppercase">Logic / Formula:</span>{formula}</div>)}
                        {note && (<div className="mt-2 text-[10px] text-blue-200 bg-blue-900/30 p-2 rounded border border-blue-800/50 leading-relaxed"><span className="font-bold mr-1 block mb-1 text-blue-300">ğŸ’¡ èªªæ˜:</span>{note}</div>)}
                        <div className={`absolute w-0 h-0 border-8 border-transparent ${layout.placement === 'top' ? 'top-full border-t-slate-900' : 'bottom-full border-b-slate-900'}`} style={{ left: layout.arrowLeft, transform: 'translateX(-50%)' }}></div>
                    </div>
                </div>
            );
            return (<React.Fragment><span ref={triggerRef} className={`inline-block cursor-help transition-colors duration-200 ${highlight ? 'text-yellow-300 border-yellow-500/50' : 'border-slate-400/50'} border-b border-dotted whitespace-nowrap`} onMouseEnter={handleMouseEnter} onMouseLeave={() => setIsVisible(false)} onClick={() => { calculatePosition(); setIsVisible(!isVisible); }}>{children}</span>{isVisible && createPortal(tooltipContent, document.body)}</React.Fragment>);
        };

        // --- Lock Screen Component ---
        const LockScreen = ({ onUnlock }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);
            const [isShaking, setIsShaking] = useState(false);
            
            // Valid passwords configuration
            const validPasswords = ['vip001', 'guest001', 'demo001'];

            const handleSubmit = (e) => {
                e.preventDefault();
                if (validPasswords.includes(password)) {
                    // Success: Add a small delay for visual feedback if desired
                    onUnlock();
                } else {
                    // Error
                    setError(true);
                    setIsShaking(true);
                    setPassword('');
                    setTimeout(() => setIsShaking(false), 500);
                }
            };

            return (
                <div className="fixed inset-0 z-50 bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4">
                    <div className={`bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-2xl w-full max-w-sm shadow-2xl flex flex-col items-center ${isShaking ? 'shake-animation' : ''}`}>
                        <div className="bg-blue-500/20 p-4 rounded-full mb-6 ring-1 ring-blue-400/50">
                            <Lock className="w-8 h-8 text-blue-200" />
                        </div>
                        <h2 className="text-xl font-bold text-white mb-2">ç³»çµ±é–å®š</h2>
                        <p className="text-blue-200 text-sm mb-6 text-center">è«‹è¼¸å…¥æˆæ¬Šé‡‘é‘°ä»¥å­˜å– P&L è©¦ç®—ç³»çµ±</p>
                        
                        <form onSubmit={handleSubmit} className="w-full space-y-4">
                            <div className="relative">
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => {
                                        setPassword(e.target.value);
                                        if(error) setError(false);
                                    }}
                                    placeholder="è¼¸å…¥å¯†ç¢¼..."
                                    className="w-full bg-slate-900/50 border border-slate-600 rounded-lg py-3 px-4 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center tracking-widest transition-all"
                                    autoFocus
                                />
                            </div>
                            
                            {error && (
                                <div className="text-red-400 text-xs text-center font-bold flex items-center justify-center gap-1 animate-pulse">
                                    <AlertTriangle size={12} />
                                    å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦
                                </div>
                            )}

                            <button 
                                type="submit"
                                className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2"
                            >
                                <Unlock size={16} />
                                è§£é–ç³»çµ±
                            </button>
                        </form>
                        <div className="mt-8 text-[10px] text-slate-500">
                            IP Ark Secure Access v2.1
                        </div>
                    </div>
                </div>
            );
        };

        const MainApp = () => {
            const [inputs, setInputs] = useState({
                exchangeRate: 31.60, mgUsd: 10000, royaltyRate: 10, channelFeeRate: 30, paymentFeeRate: 3, marketingFeeRate: 2, taxEnabled: true, taxRate: 5,
                costWine: 832, costGiftBox: 250, costSingleBox: 100, costGlass: 100, costCard: 50, priceGiftSet: 3500, priceSingle: 2500,
                moqGiftBox: 500, moqSingleBox: 500, moqGlass: 300, moqCard: 300, ratioGift: 1, ratioSingle: 5, salesGift: 500, salesSingle: 2500,
            });
            const [isLoadingRate, setIsLoadingRate] = useState(false);

            useEffect(() => {
                const fetchRate = async () => {
                    setIsLoadingRate(true);
                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                        const data = await response.json();
                        if (data && data.rates && data.rates.TWD) {
                        const bankSellingRate = parseFloat((data.rates.TWD + 0.1).toFixed(2));
                        setInputs(prev => ({ ...prev, exchangeRate: bankSellingRate }));
                        }
                    } catch (error) { console.error("Failed to fetch exchange rate:", error); } finally { setIsLoadingRate(false); }
                };
                fetchRate();
            }, []);

            const vals = useMemo(() => {
                return Object.keys(inputs).reduce((acc, key) => {
                    const val = inputs[key];
                    if (typeof val === 'boolean') { acc[key] = val; } else { acc[key] = val === '' ? 0 : parseFloat(val) || 0; }
                    return acc;
                }, {});
            }, [inputs]);

            const unitMaterialCostGift = vals.costWine + vals.costGiftBox + vals.costGlass + vals.costCard;
            const unitMaterialCostSingle = vals.costWine + vals.costSingleBox;
            const variableRate = (vals.channelFeeRate + vals.paymentFeeRate + vals.marketingFeeRate + vals.royaltyRate + (vals.taxEnabled ? vals.taxRate : 0)) / 100;
            const variableRateDisplay = (vals.channelFeeRate + vals.paymentFeeRate + vals.marketingFeeRate + vals.royaltyRate + (vals.taxEnabled ? vals.taxRate : 0));
            const variableRateNoRoyalty = variableRate - (vals.royaltyRate / 100);
            const variableRateNoRoyaltyPercent = (variableRateDisplay - vals.royaltyRate).toFixed(0);
            const unitContributionGift = vals.priceGiftSet * (1 - variableRateNoRoyalty) - unitMaterialCostGift;
            const unitContributionSingle = vals.priceSingle * (1 - variableRateNoRoyalty) - unitMaterialCostSingle;
            const mixContributionValue = (unitContributionGift * vals.ratioGift) + (unitContributionSingle * vals.ratioSingle);
            const unitVariableCostGift = vals.priceGiftSet * variableRate;
            const unitTotalCostGift = unitMaterialCostGift + unitVariableCostGift;
            const unitVariableCostSingle = vals.priceSingle * variableRate;
            const unitTotalCostSingle = unitMaterialCostSingle + unitVariableCostSingle;
            const unitNetProfitGift = vals.priceGiftSet - unitTotalCostGift;
            const unitNetProfitSingle = vals.priceSingle - unitTotalCostSingle;
            const mgTwd = vals.mgUsd * vals.exchangeRate;
            const costMoqGiftBox = vals.moqGiftBox * vals.costGiftBox;
            const costMoqSingleBox = vals.moqSingleBox * vals.costSingleBox;
            const costMoqGlass = vals.moqGlass * vals.costGlass;
            const costMoqCard = vals.moqCard * vals.costCard;
            const upfrontMaterialCost = costMoqGiftBox + costMoqSingleBox + costMoqGlass + costMoqCard;
            const totalUpfrontCash = mgTwd + upfrontMaterialCost;
            const totalSalesCount = vals.salesGift + vals.salesSingle;
            const totalRevenue = (vals.salesGift * vals.priceGiftSet) + (vals.salesSingle * vals.priceSingle);
            const totalMaterialCost = (vals.salesGift * unitMaterialCostGift) + (vals.salesSingle * unitMaterialCostSingle);
            const calculatedRoyalty = totalRevenue * (vals.royaltyRate / 100);
            const isOverMg = calculatedRoyalty > mgTwd;
            const finalLicensingCost = Math.max(mgTwd, calculatedRoyalty);
            const costChannel = totalRevenue * (vals.channelFeeRate / 100);
            const costPayment = totalRevenue * (vals.paymentFeeRate / 100);
            const costMarketing = totalRevenue * (vals.marketingFeeRate / 100);
            const costTax = vals.taxEnabled ? totalRevenue * (vals.taxRate / 100) : 0;
            const totalOpEx = costChannel + costPayment + costMarketing + finalLicensingCost + costTax;
            const avgOpExPerUnit = totalSalesCount > 0 ? totalOpEx / totalSalesCount : 0;
            const totalOpExPercent = totalRevenue > 0 ? (totalOpEx / totalRevenue) * 100 : 0;
            const avgMaterialCostPerUnit = totalSalesCount > 0 ? totalMaterialCost / totalSalesCount : 0;
            const materialCostRate = totalRevenue > 0 ? (totalMaterialCost / totalRevenue) * 100 : 0;
            const totalProjectCost = totalMaterialCost + totalOpEx;
            const netProfit = totalRevenue - totalProjectCost;
            const netProfitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
            const mixesNeeded = mixContributionValue > 0 ? Math.ceil(mgTwd / mixContributionValue) : 0;
            const bepGiftQty = mixesNeeded * vals.ratioGift;
            const bepSingleQty = mixesNeeded * vals.ratioSingle;
            const bepTotalQty = bepGiftQty + bepSingleQty;
            const recPriceGiftSet = Math.ceil(unitMaterialCostGift / (1 - variableRate - 0.15) / 10) * 10;
            const recPriceSingle = Math.ceil(unitMaterialCostSingle / (1 - variableRate - 0.15) / 10) * 10;
            const overallCostRate = totalRevenue > 0 ? (totalProjectCost / totalRevenue) * 100 : 0;

            const handleInputChange = (e) => {
                const { name, value, type, checked } = e.target;
                let newValue = type === 'checkbox' ? checked : value;
                setInputs(prev => {
                const next = { ...prev, [name]: newValue };
                const ratio = prev.ratioSingle / prev.ratioGift; 
                if (name === 'salesGift') {
                    const giftVal = parseFloat(newValue) || 0;
                    next.salesSingle = Math.round(giftVal * ratio);
                } else if (name === 'salesSingle') {
                    const singleVal = parseFloat(newValue) || 0;
                    next.salesGift = Math.round(singleVal / ratio);
                }
                return next;
                });
            };

            const handleWheel = (e) => { e.target.blur(); };
            const applyPrice = (name, val) => { setInputs(prev => ({ ...prev, [name]: val })); };
            const formatCurrency = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
            const formatNumber = (val) => new Intl.NumberFormat('zh-TW').format(val);
            const formatAvg = (val) => new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 1 }).format(val);

            const handleExport = () => {
                const fullRows = [
                ['é¡åˆ¥', 'é …ç›®', 'æ•¸å€¼', 'å–®ä½/å‚™è¨»', 'é©—ç®—å…¬å¼ / èªªæ˜'],
                ['å…¨åŸŸåƒæ•¸', 'ç¾é‡‘åŒ¯ç‡', inputs.exchangeRate, 'TWD/USD', 'å³æ™‚ API åŒ¯ç‡ (+0.1 æ¨¡æ“¬éŠ€è¡Œè³£å‡º)'],
                ['å…¨åŸŸåƒæ•¸', 'MG ä¿åº•æˆæ¬Šé‡‘', inputs.mgUsd, 'USD', 'æ‰‹å‹•è¼¸å…¥'],
                ['å…¨åŸŸåƒæ•¸', 'MG ä¿åº• (å°å¹£)', mgTwd, 'TWD', `${inputs.mgUsd} * ${inputs.exchangeRate}`],
                ['é¢¨éšªåƒæ•¸', 'ç¦®ç›’ MOQ', inputs.moqGiftBox, 'å€‹', 'æ‰‹å‹•è¼¸å…¥'],
                ['é¢¨éšªåƒæ•¸', 'å–®ç›’ MOQ', inputs.moqSingleBox, 'å€‹', 'æ‰‹å‹•è¼¸å…¥'],
                ['é¢¨éšªåƒæ•¸', 'é…’æ¯ MOQ', inputs.moqGlass, 'å€‹', 'æ‰‹å‹•è¼¸å…¥'],
                ['é¢¨éšªåƒæ•¸', 'ç´€å¿µå¡ MOQ', inputs.moqCard, 'å¼µ', 'æ‰‹å‹•è¼¸å…¥'],
                ['æˆæœ¬çµæ§‹', 'å–®ç“¶é…’é€²è²¨åƒ¹', inputs.costWine, 'TWD', 'æ‰‹å‹•è¼¸å…¥'],
                ['æˆæœ¬çµæ§‹', 'ç¦®ç›’æˆæœ¬', inputs.costGiftBox, 'TWD', 'æ‰‹å‹•è¼¸å…¥'],
                ['æˆæœ¬çµæ§‹', 'å–®æ¬¾ç›’æˆæœ¬', inputs.costSingleBox, 'TWD', 'æ‰‹å‹•è¼¸å…¥'],
                ['æˆæœ¬çµæ§‹', 'é…’æ¯æˆæœ¬', inputs.costGlass, 'TWD', 'æ‰‹å‹•è¼¸å…¥'],
                ['æˆæœ¬çµæ§‹', 'ç´€å¿µå¡æˆæœ¬', inputs.costCard, 'TWD', 'æ‰‹å‹•è¼¸å…¥'],
                ['ç‰©æ–™æˆæœ¬', 'ç¦®ç›’æ¬¾-ç¸½ç‰©æ–™æˆæœ¬', unitMaterialCostGift, 'TWD', `${inputs.costWine}+${inputs.costGiftBox}+${inputs.costGlass}+${inputs.costCard} = ${unitMaterialCostGift}`],
                ['ç‰©æ–™æˆæœ¬', 'å–®ç“¶æ¬¾-ç¸½ç‰©æ–™æˆæœ¬', unitMaterialCostSingle, 'TWD', `${inputs.costWine}+${inputs.costSingleBox} = ${unitMaterialCostSingle}`],
                ['ç‰©æ–™æˆæœ¬', 'å¹³å‡å–®å“ç‰©æ–™æˆæœ¬', avgMaterialCostPerUnit.toFixed(1), 'TWD', `ç¸½ç‰©æ–™æˆæœ¬ ${totalMaterialCost} / ç¸½éŠ·é‡ ${totalSalesCount}`],
                ['ç‰©æ–™æˆæœ¬', 'ç‰©æ–™æˆæœ¬ç‡', materialCostRate.toFixed(2), '%', `ç¸½ç‰©æ–™æˆæœ¬ / ç¸½ç‡Ÿæ”¶`],
                ['ç‡Ÿé‹è²»ç”¨', 'é€šè·¯æŠ½æˆè²»ç‡', inputs.channelFeeRate, '%', 'æ‰‹å‹•è¼¸å…¥'],
                ['ç‡Ÿé‹è²»ç”¨', 'é‡‘æµè²»ç‡', inputs.paymentFeeRate, '%', 'æ‰‹å‹•è¼¸å…¥'],
                ['ç‡Ÿé‹è²»ç”¨', 'è¡ŒéŠ·è²»ç‡', inputs.marketingFeeRate, '%', 'æ‰‹å‹•è¼¸å…¥'],
                ['ç‡Ÿé‹è²»ç”¨', 'æˆæ¬Šé‡‘åˆ†æ½¤ç‡', inputs.royaltyRate, '%', 'æ‰‹å‹•è¼¸å…¥'],
                ['ç‡Ÿé‹è²»ç”¨', 'ç‡Ÿæ¥­ç¨…ç‡', inputs.taxEnabled ? inputs.taxRate : 0, '%', inputs.taxEnabled ? 'å·²å•Ÿç”¨ (5%)' : 'æœªå•Ÿç”¨'],
                ['å®šåƒ¹ç­–ç•¥', 'ç¦®ç›’æ¬¾å”®åƒ¹', inputs.priceGiftSet, 'TWD', 'æ‰‹å‹•è¼¸å…¥'],
                ['å®šåƒ¹ç­–ç•¥', 'å–®ç“¶æ¬¾å”®åƒ¹', inputs.priceSingle, 'TWD', 'æ‰‹å‹•è¼¸å…¥'],
                ['æ··åˆè²¢ç»', 'æ¯çµ„æ··åˆè²¢ç»', mixContributionValue.toFixed(0), 'TWD', `ç¦®ç›’è²¢ç» + (å–®ç“¶è²¢ç» * 5)`],
                ['æç›Šè¡¨', 'ç¸½ç‡Ÿæ”¶ (Revenue)', totalRevenue, 'TWD', `(ç¦®ç›’éŠ·é‡${inputs.salesGift}*åƒ¹${inputs.priceGiftSet}) + (å–®ç“¶éŠ·é‡${inputs.salesSingle}*åƒ¹${inputs.priceSingle})`],
                ['æç›Šè¡¨', 'ç¸½ç‰©æ–™æˆæœ¬', totalMaterialCost, 'TWD', `(ç¦®ç›’éŠ·é‡${inputs.salesGift}*ç‰©æ–™${unitMaterialCostGift}) + (å–®ç“¶éŠ·é‡${inputs.salesSingle}*ç‰©æ–™${unitMaterialCostSingle})`],
                ['æç›Šè¡¨', 'ç¸½ç‡Ÿé‹è²»ç”¨ (OpEx)', totalOpEx.toFixed(0), 'TWD', 'é€šè·¯+é‡‘æµ+è¡ŒéŠ·+æˆæ¬Šé‡‘+ç¨…'],
                ['æç›Šè¡¨', 'å°ˆæ¡ˆç¸½æˆæœ¬', totalProjectCost.toFixed(0), 'TWD', 'ç¸½ç‰©æ–™æˆæœ¬ + ç¸½ç‡Ÿé‹è²»ç”¨'],
                ['æç›Šè¡¨', 'æ·¨åˆ© (Net Profit)', netProfit.toFixed(0), 'TWD', 'ç¸½ç‡Ÿæ”¶ - å°ˆæ¡ˆç¸½æˆæœ¬'],
                ['æç›Šè¡¨', 'æ·¨åˆ©ç‡', netProfitMargin.toFixed(2), '%', '(æ·¨åˆ© / ç¸½ç‡Ÿæ”¶) * 100%'],
                ['é¢¨éšªåˆ†æ', 'äº‹å‰æ”¯ä»˜ç¾é‡‘ (æ²ˆæ²’æˆæœ¬)', totalUpfrontCash, 'TWD', `MG(${mgTwd}) + ç¦®ç›’(${costMoqGiftBox}) + å–®ç›’(${costMoqSingleBox}) + é…’æ¯(${costMoqGlass}) + ç´€å¿µå¡(${costMoqCard})`],
                ['é¢¨éšªåˆ†æ', 'æç›Šå¹³è¡¡é» (ç¸½é‡)', bepTotalQty, 'ç“¶', `ç¦®ç›’ ${bepGiftQty} + å–®ç“¶ ${bepSingleQty}`],
                ];
                const csvContent = "\uFEFF" + fullRows.map(e => e.map(cell => `"${cell}"`).join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.setAttribute("download", "å¯Œé‚¦æ‚å°‡è¯åé…’_æç›Šè©¦ç®—è¡¨.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800 flex flex-col">
                <div className="max-w-7xl mx-auto space-y-6 flex-grow">
                    
                    {/* Header */}
                    <header className="bg-gradient-to-r from-blue-900 to-slate-800 text-white p-6 rounded-2xl shadow-lg flex flex-col md:flex-row justify-between items-center relative z-20">
                    <div className="flex items-center gap-3 mb-4 md:mb-0">
                        <Calculator className="w-8 h-8 text-blue-200" />
                        <div className="flex flex-col">
                        <h1 className="text-lg font-bold flex items-baseline gap-1">
                            å¯Œé‚¦æ‚å°‡è¯åé…’ P&L 
                            <span className="text-[10px] text-blue-200 font-normal">V2.0</span>
                        </h1>
                        <p className="text-blue-200 text-xs mt-0.5">å…¨æˆæœ¬åˆ†æï¼šå«é€šè·¯ã€ç¨…é‡‘ã€æˆæ¬Šé‡‘èˆ‡ç‰©æ–™</p>
                        </div>
                    </div>
                    
                    <div className="mt-4 md:mt-0 flex gap-4 text-sm bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                        <div className="text-center">
                            <div className="text-blue-200 text-xs mb-1 flex items-center justify-center gap-1">
                            <Tooltip 
                                title="å³æ™‚åŒ¯ç‡è³‡è¨Š" 
                                note="ç³»çµ±å·²è‡ªå‹•æŠ“å–ç•¶æ—¥åƒè€ƒåŒ¯ç‡ (ExchangeRate-API)ã€‚è‹¥æ‚¨æœ‰æŒ‡å®šçš„åˆç´„åŒ¯ç‡ï¼Œè«‹ç›´æ¥é»æ“Šä¸‹æ–¹æ•¸å­—ä¿®æ”¹ã€‚"
                            >
                                <span className="cursor-help flex items-center gap-1 border-b border-dotted border-blue-400/30">
                                ç¾é‡‘åŒ¯ç‡
                                {isLoadingRate ? <RefreshCw className="w-3 h-3 animate-spin text-yellow-300" /> : <Info className="w-3 h-3 text-blue-300" />}
                                </span>
                            </Tooltip>
                            </div>
                            <div className="flex items-center justify-center gap-1 font-mono font-bold">
                            <span>1 :</span>
                            <input
                                type="number"
                                name="exchangeRate"
                                value={inputs.exchangeRate}
                                onChange={handleInputChange}
                                onWheel={handleWheel}
                                className="w-16 bg-transparent border-b border-blue-400/50 text-white text-center focus:outline-none focus:border-yellow-400 no-spinner"
                            />
                            </div>
                        </div>
                        <div className="w-px bg-white/20"></div>
                        <div className="text-center">
                            <div className="text-blue-200 text-xs mb-1">äº‹å‰ä¿åº• (MG)</div>
                            <Tooltip 
                            title="MG æˆæœ¬ (å°å¹£)"
                            items={[{ label: 'MG USD', value: inputs.mgUsd }, { label: 'åŒ¯ç‡', value: inputs.exchangeRate }]}
                            formula={`${inputs.mgUsd} * ${inputs.exchangeRate} = ${formatNumber(mgTwd)}`}
                            highlight={true}
                            >
                            <div className="font-mono font-bold text-yellow-300 cursor-pointer">
                                ${formatNumber(inputs.mgUsd)} USD
                            </div>
                            </Tooltip>
                        </div>
                    </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 relative z-10">
                    
                    {/* å·¦å´ï¼šè¨­å®šèˆ‡å®šåƒ¹ */}
                    <div className="lg:col-span-4 space-y-6">
                        
                        {/* 1. å®šåƒ¹ç­–ç•¥ */}
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-blue-500">
                        <h2 className="text-base font-bold mb-4 flex items-center gap-2 text-slate-700 border-b pb-2">
                            <DollarSign className="w-4 h-4" />
                            å®šåƒ¹ç­–ç•¥ (Price)
                        </h2>
                        <div className="space-y-6">
                            {/* ç¦®ç›’æ¬¾ */}
                            <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div className="flex justify-between mb-1">
                                <label className="text-sm font-medium text-slate-700">ç¦®ç›’æ¬¾ å”®åƒ¹</label>
                                <Tooltip 
                                title="å–®å“æ·¨è³º (P&Lè§€é»)" 
                                items={[
                                    { label: 'å”®åƒ¹', value: formatCurrency(vals.priceGiftSet) },
                                    { label: 'å–®å“ç¸½æˆæœ¬', value: formatCurrency(unitTotalCostGift) }
                                ]}
                                formula={`${vals.priceGiftSet} (å”®åƒ¹) - ${formatNumber(unitTotalCostGift)} (ç¸½æˆæœ¬) = ${formatNumber(unitNetProfitGift)}`}
                                >
                                <span className={`text-xs ${unitNetProfitGift > 0 ? 'text-green-600' : 'text-red-500'} font-bold`}>
                                    å–®å“æ·¨è³º: {formatCurrency(unitNetProfitGift)}
                                </span>
                                </Tooltip>
                            </div>
                            <input
                                type="number"
                                name="priceGiftSet"
                                value={inputs.priceGiftSet}
                                onChange={handleInputChange}
                                onWheel={handleWheel}
                                placeholder="0"
                                className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-right font-bold text-lg text-blue-900 bg-white no-spinner"
                            />
                            <div className="flex justify-between mt-2 text-xs border-t border-slate-200 pt-2">
                                <Tooltip 
                                title="å–®å“ç¸½æˆæœ¬æ‹†è§£" 
                                items={[
                                    { label: 'åŸºç¤ç‰©æ–™', value: formatCurrency(unitMaterialCostGift) },
                                    { label: 'è®Šå‹•è²»ç”¨(å«æˆæ¬Šé‡‘)', value: formatCurrency(unitVariableCostGift) }
                                ]}
                                formula={`ç‰©æ–™ ${unitMaterialCostGift} + (å”®åƒ¹ * ${variableRateDisplay}%)`}
                                >
                                <span className="text-slate-500">ç¸½æˆæœ¬: {formatCurrency(unitTotalCostGift)}</span>
                                </Tooltip>
                            </div>
                            <div className="flex justify-between mt-1 text-xs">
                                <Tooltip title="ç¸½æˆæœ¬ä½”æ¯”" formula={`(${formatNumber(unitTotalCostGift)} / ${vals.priceGiftSet}) * 100%`}>
                                <span className="text-slate-500">
                                    ç¸½æˆæœ¬ä½”æ¯”: {vals.priceGiftSet > 0 ? ((unitTotalCostGift/vals.priceGiftSet)*100).toFixed(1) : 0}%
                                </span>
                                </Tooltip>
                                <Tooltip title="æ·¨åˆ©ç‡" formula={`(${formatNumber(unitNetProfitGift)} / ${vals.priceGiftSet}) * 100%`}>
                                <span className={`${unitNetProfitGift > 0 ? 'text-green-600' : 'text-red-500'} font-medium`}>
                                    æ·¨åˆ©ç‡: {vals.priceGiftSet > 0 ? ((unitNetProfitGift/vals.priceGiftSet)*100).toFixed(1) : 0}%
                                </span>
                                </Tooltip>
                            </div>
                            <div className="mt-2 flex items-center justify-between bg-blue-100 p-2 rounded text-xs text-blue-800">
                                <div className="flex items-center gap-1">
                                <Sparkles className="w-3 h-3 text-blue-600" />
                                <span>AIå»ºè­° (æ·¨åˆ©15%): <span className="font-bold">{formatCurrency(recPriceGiftSet)}</span></span>
                                </div>
                                <button onClick={() => applyPrice('priceGiftSet', recPriceGiftSet)} className="flex items-center gap-1 bg-white hover:bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-200 transition-colors">
                                <ArrowDownToLine className="w-3 h-3" /> å¡«å…¥
                                </button>
                            </div>
                            </div>

                            {/* å–®ç“¶æ¬¾ */}
                            <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div className="flex justify-between mb-1">
                                <label className="text-sm font-medium text-slate-700">å–®ç“¶æ¬¾ å”®åƒ¹</label>
                                <Tooltip 
                                title="å–®å“æ·¨è³º (P&Lè§€é»)" 
                                items={[
                                    { label: 'å”®åƒ¹', value: formatCurrency(vals.priceSingle) },
                                    { label: 'å–®å“ç¸½æˆæœ¬', value: formatCurrency(unitTotalCostSingle) }
                                ]}
                                formula={`${vals.priceSingle} (å”®åƒ¹) - ${formatNumber(unitTotalCostSingle)} (ç¸½æˆæœ¬) = ${formatNumber(unitNetProfitSingle)}`}
                                >
                                <span className={`text-xs ${unitNetProfitSingle > 0 ? 'text-green-600' : 'text-red-500'} font-bold`}>
                                    å–®å“æ·¨è³º: {formatCurrency(unitNetProfitSingle)}
                                </span>
                                </Tooltip>
                            </div>
                            <input
                                type="number"
                                name="priceSingle"
                                value={inputs.priceSingle}
                                onChange={handleInputChange}
                                onWheel={handleWheel}
                                placeholder="0"
                                className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-right font-bold text-lg text-blue-900 bg-white no-spinner"
                            />
                            <div className="flex justify-between mt-2 text-xs border-t border-slate-200 pt-2">
                                <Tooltip 
                                title="å–®å“ç¸½æˆæœ¬æ‹†è§£" 
                                items={[
                                    { label: 'åŸºç¤ç‰©æ–™', value: formatCurrency(unitMaterialCostSingle) },
                                    { label: 'è®Šå‹•è²»ç”¨(å«æˆæ¬Šé‡‘)', value: formatCurrency(unitVariableCostSingle) }
                                ]}
                                formula={`ç‰©æ–™ ${unitMaterialCostSingle} + (å”®åƒ¹ * ${variableRateDisplay}%)`}
                                >
                                <span className="text-slate-500">ç¸½æˆæœ¬: {formatCurrency(unitTotalCostSingle)}</span>
                                </Tooltip>
                            </div>
                            <div className="flex justify-between mt-1 text-xs">
                                <Tooltip title="ç¸½æˆæœ¬ä½”æ¯”" formula={`(${formatNumber(unitTotalCostSingle)} / ${vals.priceSingle}) * 100%`}>
                                <span className="text-slate-500">
                                    ç¸½æˆæœ¬ä½”æ¯”: {vals.priceSingle > 0 ? ((unitTotalCostSingle/vals.priceSingle)*100).toFixed(1) : 0}%
                                </span>
                                </Tooltip>
                                <Tooltip title="æ·¨åˆ©ç‡" formula={`(${formatNumber(unitNetProfitSingle)} / ${vals.priceSingle}) * 100%`}>
                                <span className={`${unitNetProfitSingle > 0 ? 'text-green-600' : 'text-red-500'} font-medium`}>
                                    æ·¨åˆ©ç‡: {vals.priceSingle > 0 ? ((unitNetProfitSingle/vals.priceSingle)*100).toFixed(1) : 0}%
                                </span>
                                </Tooltip>
                            </div>
                            <div className="mt-2 flex items-center justify-between bg-blue-100 p-2 rounded text-xs text-blue-800">
                                <div className="flex items-center gap-1">
                                <Sparkles className="w-3 h-3 text-blue-600" />
                                <span>AIå»ºè­° (æ·¨åˆ©15%): <span className="font-bold">{formatCurrency(recPriceSingle)}</span></span>
                                </div>
                                <button onClick={() => applyPrice('priceSingle', recPriceSingle)} className="flex items-center gap-1 bg-white hover:bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-200 transition-colors">
                                <ArrowDownToLine className="w-3 h-3" /> å¡«å…¥
                                </button>
                            </div>
                            </div>
                        </div>
                        </div>

                        {/* 2. ç‡Ÿé‹è²»ç”¨è¨­å®š (OpEx) */}
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-purple-500">
                        <h2 className="text-base font-bold mb-4 flex items-center gap-2 text-slate-700 border-b pb-2">
                            <Settings className="w-4 h-4" />
                            ç‡Ÿé‹è²»ç”¨è¨­å®š (OpEx)
                        </h2>
                        <div className="space-y-4">
                            {[
                            { label: 'é€šè·¯æŠ½æˆ (Channel)', name: 'channelFeeRate', cost: costChannel, rate: inputs.channelFeeRate },
                            { label: 'é‡‘æµè²»ç”¨ (Payment)', name: 'paymentFeeRate', cost: costPayment, rate: inputs.paymentFeeRate },
                            { label: 'è¡ŒéŠ·è²»ç”¨ (Marketing)', name: 'marketingFeeRate', cost: costMarketing, rate: inputs.marketingFeeRate },
                            { label: 'æˆæ¬Šé‡‘åˆ†æ½¤ (Royalty)', name: 'royaltyRate', cost: finalLicensingCost, rate: inputs.royaltyRate, note: 'Max(MG, 10%)' }, 
                            ].map((item) => (
                            <div key={item.name}>
                                <div className="flex justify-between items-start mb-1">
                                <label className="text-sm font-medium text-slate-700 mt-1">{item.label}</label>
                                <div className="flex flex-col items-end">
                                    <Tooltip 
                                    title={`${item.label} æˆæœ¬`} 
                                    formula={item.name === 'royaltyRate' 
                                        ? `Max(MG $${formatNumber(mgTwd)}, ç‡Ÿæ”¶ * ${item.rate}%)` 
                                        : `ç¸½ç‡Ÿæ”¶ $${formatNumber(totalRevenue)} * ${item.rate}%`}
                                    >
                                    <div className="text-xs font-bold text-slate-700 mb-0.5">{formatCurrency(item.cost)}</div>
                                    </Tooltip>
                                    <Tooltip title="å¹³å‡å–®å“æ”¤æ" formula={`${formatNumber(item.cost)} (ç¸½è²»ç”¨) / ${totalSalesCount} (ç¸½éŠ·é‡)`}>
                                    <div className="text-[10px] text-slate-400">å‡ {totalSalesCount > 0 ? formatAvg(item.cost / totalSalesCount) : 0}/å€‹</div>
                                    </Tooltip>
                                </div>
                                </div>
                                <div className="relative">
                                <input
                                    type="number"
                                    name={item.name}
                                    value={inputs[item.name]}
                                    onChange={handleInputChange}
                                    onWheel={handleWheel}
                                    className="w-full pl-2 pr-8 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-purple-500 outline-none text-right font-bold"
                                />
                                <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                                    <Percent size={16} />
                                </div>
                                </div>
                            </div>
                            ))}

                            <div className="flex justify-between items-center pt-2 border-t mt-2">
                            <div className="flex flex-col">
                                <label className="text-sm font-medium text-slate-700 flex items-center gap-2">
                                ç‡Ÿæ¥­ç¨… (5%)
                                <span className="text-[10px] bg-slate-100 px-1 rounded text-slate-500">Business Tax</span>
                                </label>
                                <span className="text-[10px] text-slate-400 mt-0.5">æ˜¯å¦å°‡ç‡Ÿæ¥­ç¨…è¨˜å…¥æˆæœ¬</span>
                            </div>
                            <div className="flex flex-col items-end mr-3">
                                <Tooltip title="ç‡Ÿæ¥­ç¨…ç¸½é¡" formula={`ç¸½ç‡Ÿæ”¶ ${formatNumber(totalRevenue)} * ${inputs.taxEnabled ? 5 : 0}%`}>
                                <div className="text-xs font-bold text-slate-700 mb-0.5">{formatCurrency(costTax)}</div>
                                </Tooltip>
                                <Tooltip title="å¹³å‡å–®å“ç¨…é¡" formula={`${formatNumber(costTax)} (ç¸½ç¨…é¡) / ${totalSalesCount} (ç¸½éŠ·é‡)`}>
                                <div className="text-[10px] text-slate-400">å‡ {totalSalesCount > 0 ? formatAvg(costTax / totalSalesCount) : 0}/å€‹</div>
                                </Tooltip>
                            </div>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="taxEnabled" checked={inputs.taxEnabled} onChange={handleInputChange} className="sr-only peer" />
                                <div className="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:bg-purple-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                            </label>
                            </div>
                            
                            <div className="mt-4 pt-3 border-t border-purple-100 bg-purple-50 p-3 rounded-lg">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-xs font-bold text-purple-800">ç‡Ÿé‹ç¸½è²»ç”¨</span>
                                    <div className="flex items-center gap-2">
                                    <Tooltip title="è²»ç”¨ä½”æ¯”" formula={`(${formatNumber(totalOpEx)} / ${formatNumber(totalRevenue)}) * 100%`}>
                                        <span className="text-xs bg-purple-200 text-purple-800 px-1.5 py-0.5 rounded font-bold cursor-help">
                                        {totalOpExPercent.toFixed(1)}%
                                        </span>
                                    </Tooltip>
                                    <Tooltip 
                                        title="ç¸½ç‡Ÿé‹è²»ç”¨ (OpEx)" 
                                        formula="é€šè·¯ + é‡‘æµ + è¡ŒéŠ· + æˆæ¬Š + ç¨…"
                                        items={[
                                        { label: 'é€šè·¯', value: formatNumber(costChannel) },
                                        { label: 'æˆæ¬Šé‡‘', value: formatNumber(finalLicensingCost) },
                                        { label: 'å…¶ä»–', value: formatNumber(costPayment + costMarketing + costTax) },
                                        ]}
                                    >
                                        <span className="text-sm font-bold text-purple-900">{formatCurrency(totalOpEx)}</span>
                                    </Tooltip>
                                    </div>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-xs text-purple-600">å¹³å‡å–®å“ç¸½è²»ç”¨</span>
                                    <Tooltip title="OpEx Per Unit" formula={`${formatNumber(totalOpEx)} / ${totalSalesCount}`}>
                                    <span className="text-xs font-mono text-purple-700">{formatCurrency(avgOpExPerUnit)} / å€‹</span>
                                    </Tooltip>
                                </div>
                            </div>
                        </div>
                        </div>

                        {/* 3. åŸºç¤æˆæœ¬è¨­å®š (Cost) */}
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 className="text-base font-bold mb-4 flex items-center gap-2 text-slate-700 border-b pb-2">
                            <Package className="w-4 h-4" />
                            åŸºç¤ç‰©æ–™æˆæœ¬ (Material Only)
                        </h2>
                        <div className="space-y-3 text-sm">
                            {[
                            { label: 'å–®ç“¶é…’ é€²è²¨åƒ¹', name: 'costWine' },
                            { label: 'ç¦®ç›’ æˆæœ¬', name: 'costGiftBox' },
                            { label: 'å–®æ¬¾ç›’ æˆæœ¬', name: 'costSingleBox' },
                            { label: 'é…’æ¯ æˆæœ¬', name: 'costGlass' },
                            { label: 'ç´€å¿µå¡ æˆæœ¬', name: 'costCard' },
                            ].map((item) => (
                            <div key={item.name} className="flex justify-between items-center group">
                                <label className="text-slate-500 group-hover:text-blue-600 transition-colors">{item.label}</label>
                                <input type="number" name={item.name} value={inputs[item.name]} onChange={handleInputChange} onWheel={handleWheel} placeholder="0" className="w-24 text-right border-b border-slate-200 focus:border-blue-500 outline-none font-mono bg-transparent no-spinner" />
                            </div>
                            ))}
                        </div>
                        
                        {/* æ–°å¢ç‰©æ–™åŒ¯ç¸½å€å¡Š */}
                        <div className="mt-4 pt-3 border-t border-slate-200 bg-slate-50 p-3 rounded-lg space-y-2">
                            <div className="flex justify-between text-xs">
                                <span className="text-slate-500">ç¦®ç›’æ¬¾ ç‰©æ–™æˆæœ¬</span>
                                <Tooltip title="ç¦®ç›’ç‰©æ–™åŠ ç¸½" formula={`é…’${inputs.costWine} + ç›’${inputs.costGiftBox} + æ¯${inputs.costGlass} + å¡${inputs.costCard}`}>
                                <span className="font-mono font-bold text-slate-700">{formatCurrency(unitMaterialCostGift)}</span>
                                </Tooltip>
                            </div>
                            <div className="flex justify-between text-xs">
                                <span className="text-slate-500">å–®ç“¶æ¬¾ ç‰©æ–™æˆæœ¬</span>
                                <Tooltip title="å–®ç“¶ç‰©æ–™åŠ ç¸½" formula={`é…’${inputs.costWine} + ç›’${inputs.costSingleBox}`}>
                                <span className="font-mono font-bold text-slate-700">{formatCurrency(unitMaterialCostSingle)}</span>
                                </Tooltip>
                            </div>
                            <div className="border-t border-slate-200 my-1"></div>
                            <div className="flex justify-between text-xs">
                                <span className="text-slate-500">å¹³å‡å–®å“ç‰©æ–™æˆæœ¬</span>
                                <Tooltip title="åŠ æ¬Šå¹³å‡ç‰©æ–™" formula={`ç¸½ç‰©æ–™æˆæœ¬ ${formatNumber(totalMaterialCost)} / ç¸½éŠ·é‡ ${totalSalesCount}`}>
                                <span className="font-mono font-bold text-slate-700">{formatCurrency(avgMaterialCostPerUnit)}</span>
                                </Tooltip>
                            </div>
                            <div className="flex justify-between text-xs">
                                <span className="text-slate-500">å–®å“ç‰©æ–™æˆæœ¬ç‡ (ç‰©æ–™/ç‡Ÿæ”¶)</span>
                                <Tooltip title="ç‰©æ–™æˆæœ¬ç‡" formula={`ç¸½ç‰©æ–™ ${formatNumber(totalMaterialCost)} / ç¸½ç‡Ÿæ”¶ ${formatNumber(totalRevenue)}`}>
                                <span className="font-mono font-bold text-blue-600">{materialCostRate.toFixed(1)}%</span>
                                </Tooltip>
                            </div>
                        </div>
                        </div>

                    </div>

                    {/* å³å´æ¬„ä½ï¼šå ±è¡¨èˆ‡åˆ†æ (ä½” 8 ç­‰ä»½) */}
                    <div className="lg:col-span-8 space-y-6">

                        {/* æ–°å¢ï¼šæ•´é«”æŒ‡æ¨™ (ç¨ç«‹å€å¡Šï¼Œç½®é ‚) */}
                        <div className="bg-slate-800 p-5 rounded-xl shadow-md text-white flex flex-col justify-center">
                            <h2 className="text-base font-bold mb-4 flex items-center gap-2 text-yellow-400 border-b border-slate-600 pb-2">
                            <PieChart className="w-4 h-4" />
                            æ•´é«”æŒ‡æ¨™ (Overall Metrics)
                            </h2>
                            <div className="grid grid-cols-2 gap-4 text-center">
                            <div className="bg-white/10 p-3 rounded-lg">
                                <div className="text-xs text-slate-300 mb-1">{inputs.taxEnabled ? 'ç¨…å¾Œ' : 'ç¨…å‰'}æ·¨åˆ©ç‡</div>
                                <Tooltip title="æ·¨åˆ©ç‡" formula={`1 - (ç¸½æˆæœ¬ ${formatNumber(totalProjectCost)} / ç¸½ç‡Ÿæ”¶ ${formatNumber(totalRevenue)})`}>
                                    <div className={`text-2xl font-bold ${netProfitMargin > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    {netProfitMargin.toFixed(1)}%
                                    </div>
                                </Tooltip>
                                <div className="text-[10px] text-slate-400 mt-1">1 - (ç¸½æˆæœ¬/ç¸½ç‡Ÿæ”¶)</div>
                            </div>
                            <div className="bg-white/10 p-3 rounded-lg">
                                <div className="text-xs text-slate-300 mb-1">ç¸½æˆæœ¬ç‡</div>
                                <Tooltip title="ç¸½æˆæœ¬ç‡" formula={`ç¸½æˆæœ¬ ${formatNumber(totalProjectCost)} / ç¸½ç‡Ÿæ”¶ ${formatNumber(totalRevenue)}`}>
                                    <div className="text-2xl font-bold text-white">
                                    {overallCostRate.toFixed(1)}%
                                    </div>
                                </Tooltip>
                                <div className="text-[10px] text-slate-400 mt-1">ç¸½æˆæœ¬/ç¸½ç‡Ÿæ”¶</div>
                            </div>
                            </div>
                        </div>

                        {/* A. å°ˆæ¡ˆé¢¨éšªå„€è¡¨æ¿ */}
                        <div className="bg-slate-800 text-white rounded-xl p-6 shadow-md relative">
                        <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none overflow-hidden rounded-xl h-full w-full">
                            <Wallet size={120} className="absolute top-4 right-4" />
                        </div>
                        <div className="relative z-10">
                            {/* ä¿®æ”¹ï¼šåŠ å¤§æ¨™é¡Œ */}
                            <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-yellow-400">
                            <AlertTriangle className="w-5 h-5" />
                            æç›Šå¹³è¡¡åˆ†æ (Break-even Analysis)
                            </h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div className="space-y-3">
                                {/* ä¿®æ”¹ï¼šåŠ å¤§æ¨™é¡Œ */}
                                <div className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2 border-b border-slate-700 pb-1">æœ€ä½èµ·è¨‚é‡ (MOQ)</div>
                                {[
                                    { label: 'ç¦®ç›’ MOQ', name: 'moqGiftBox' },
                                    { label: 'å–®ç›’ MOQ', name: 'moqSingleBox' },
                                    { label: 'é…’æ¯ MOQ', name: 'moqGlass' },
                                    { label: 'ç´€å¿µå¡ MOQ', name: 'moqCard' },
                                ].map(item => (
                                    <div key={item.name} className="flex justify-between items-center text-sm">
                                    <label className="text-slate-300">{item.label}</label>
                                    <input 
                                        type="number"
                                        name={item.name}
                                        value={inputs[item.name]}
                                        onChange={handleInputChange}
                                        onWheel={handleWheel}
                                        className="w-20 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-right text-white focus:ring-1 focus:ring-yellow-400 outline-none no-spinner"
                                    />
                                    </div>
                                ))}
                                </div>

                                <div className="flex flex-col justify-between">
                                <div>
                                    {/* ä¿®æ”¹ï¼šåŠ å¤§æ¨™é¡Œ */}
                                    <div className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2 border-b border-slate-700 pb-1">ä¿åº•æˆæ¬Šé‡‘ (MG)</div>
                                    <div className="flex justify-between items-center text-sm mb-4">
                                        <label className="text-slate-300">MG é‡‘é¡ (USD)</label>
                                        <div className="relative">
                                        <span className="absolute left-2 top-1 text-slate-400">$</span>
                                        <input 
                                            type="number"
                                            name="mgUsd"
                                            value={inputs.mgUsd}
                                            onChange={handleInputChange}
                                            onWheel={handleWheel}
                                            className="w-24 bg-slate-700 border border-slate-600 rounded pl-5 pr-2 py-1 text-right text-yellow-300 font-bold focus:ring-1 focus:ring-yellow-400 outline-none no-spinner"
                                        />
                                        </div>
                                    </div>
                                </div>
                                
                                <Tooltip 
                                    title="æ²ˆæ²’æˆæœ¬æ‹†è§£ (Sunk Costs)" 
                                    items={[
                                    { label: 'MG (TWD)', value: formatNumber(mgTwd) },
                                    { label: 'ç‰©æ–™ MOQ æˆæœ¬', value: formatNumber(upfrontMaterialCost) }
                                    ]}
                                    formula={`MG ${formatNumber(mgTwd)} + åŒ…æ MOQ ${formatNumber(upfrontMaterialCost)}`}
                                    note="é€™æ˜¯å°ˆæ¡ˆå•Ÿå‹•æ™‚å¿…é ˆå…ˆæ”¯ä»˜çš„ç¾é‡‘ç¸½é¡ã€‚åœ¨ P&L å ±è¡¨ä¸­ï¼Œç‰©æ–™æˆæœ¬æœƒéš¨éŠ·é‡åˆ†æ”¤ï¼Œä½†æ­¤è™•é¡¯ç¤ºçš„æ˜¯ç¾é‡‘é¢¨éšªã€‚"
                                >
                                    <div className="bg-white/10 p-3 rounded-lg border border-white/10 cursor-help">
                                        {/* ä¿®æ”¹ï¼šåŠ å¤§æ¨™é¡Œèˆ‡èªªæ˜ */}
                                        <div className="text-sm text-slate-400 mb-1">ç¸½æ²ˆæ²’æˆæœ¬ (Total Upfront Cash)</div>
                                        <div className="text-2xl font-bold font-mono text-white mb-1">{formatCurrency(totalUpfrontCash)}</div>
                                        <div className="text-xs text-slate-400 leading-tight">
                                        å…¬å¼: MG + ç¦®ç›’/å–®ç›’/é…’æ¯/å¡ç‰‡ MOQæˆæœ¬
                                        </div>
                                    </div>
                                </Tooltip>
                                </div>
                            </div>

                            <div className={`p-4 rounded-lg backdrop-blur-md border ${mixContributionValue > 0 ? 'bg-green-900/20 border-green-500/30' : 'bg-red-900/20 border-red-500/30'}`}>
                                <div className="flex flex-col justify-between gap-4">
                                    <div>
                                        {/* ä¿®æ”¹ï¼šåŠ å¤§æ¨™é¡Œ */}
                                        <div className="text-sm text-yellow-200 font-bold mb-1 flex items-center gap-1">
                                        <AlertTriangle className="w-4 h-4" />
                                        æç›Šå¹³è¡¡é» (P&L Break-even)
                                        </div>
                                        <div className="text-xs text-slate-300 leading-relaxed mb-3">
                                        {mixContributionValue > 0 
                                            ? `éœ€éŠ·å”®ä»¥ä¸‹æ•¸é‡ä»¥å›æ”¶å›ºå®šæˆæœ¬ (MG)ï¼Œä½¿æ·¨åˆ©æ­¸é›¶ã€‚`
                                            : 'ç„¡æ³•å›æœ¬ï¼šè®Šå‹•æˆæœ¬éé«˜ï¼Œæ¯è³£ä¸€çµ„éƒ½åœ¨è™§éŒ¢'
                                        }
                                        </div>
                                        
                                        {/* Mixed Contribution Info */}
                                        <div className="mb-4 bg-black/20 p-3 rounded flex justify-between items-center">
                                        <div className="flex flex-col">
                                            {/* ä¿®æ”¹ï¼šåŠ å¤§å­—é«” */}
                                            <span className="text-sm text-slate-300 font-bold">æ¯çµ„æ··åˆè²¢ç» (1:{inputs.ratioSingle})</span>
                                            <span className="text-xs text-slate-400">éŠ·å”® 1 ç¦®ç›’ + {inputs.ratioSingle} å–®ç“¶</span>
                                        </div>
                                        <Tooltip 
                                            title="æ··åˆè²¢ç» (ä¸å«æˆæ¬Šé‡‘) è¨ˆç®—æ‹†è§£" 
                                            items={[
                                            { label: 'ç¦®ç›’å”®åƒ¹', value: formatCurrency(vals.priceGiftSet) },
                                            { label: '- ç¦®ç›’ç‰©æ–™', value: `-${formatCurrency(unitMaterialCostGift)}` },
                                            { label: `- è®Šå‹•è²»(${variableRateNoRoyaltyPercent}%)`, value: `-${formatCurrency(vals.priceGiftSet * variableRateNoRoyalty)}` },
                                            { label: '= ç¦®ç›’å–®å“è²¢ç»', value: formatCurrency(unitContributionGift), isTotal: true },
                                            { label: '---', value: '---' },
                                            { label: 'å–®ç“¶å”®åƒ¹', value: formatCurrency(vals.priceSingle) },
                                            { label: '- å–®ç“¶ç‰©æ–™', value: `-${formatCurrency(unitMaterialCostSingle)}` },
                                            { label: `- è®Šå‹•è²»(${variableRateNoRoyaltyPercent}%)`, value: `-${formatCurrency(vals.priceSingle * variableRateNoRoyalty)}` },
                                            { label: '= å–®ç“¶å–®å“è²¢ç»', value: formatCurrency(unitContributionSingle), isTotal: true },
                                            ]}
                                            formula={`(${formatNumber(unitContributionGift)}ç¦®ç›’ * 1) + (${formatNumber(unitContributionSingle)}å–®ç“¶ * ${inputs.ratioSingle}) = ${formatNumber(mixContributionValue)}`}
                                            note={`ç‚ºä»€éº¼åªå›æ”¶ MGï¼Ÿå› ç‚ºåœ¨æœƒè¨ˆæç›Šè¡¨ä¸­ï¼Œæœªå”®å‡ºçš„ MOQ åº«å­˜æ˜¯è³‡ç”¢è€Œéè²»ç”¨ã€‚è¦è®“æ·¨åˆ©ç‚º 0ï¼Œåªéœ€ç‡Ÿæ”¶ç”¢ç”Ÿçš„æ¯›åˆ©(è²¢ç») è¶³ä»¥æ”¯ä»˜ MG å³å¯ã€‚`}
                                        >
                                            <span className="text-xl font-mono font-bold text-green-400 cursor-help border-b border-dotted border-green-400/30">
                                            {formatCurrency(mixContributionValue)}
                                            </span>
                                        </Tooltip>
                                        </div>
                                    </div>
                                    
                                    {mixContributionValue > 0 && (
                                    // Grid Layout for perfect centering
                                    <div className="grid grid-cols-3 gap-2 mt-2 text-center">
                                        {/* Gift */}
                                        <div className="flex flex-col items-center justify-end">
                                            {/* ä¿®æ”¹ï¼šåŠ å¤§æ¨™ç±¤å­—é«” */}
                                            <div className="text-xs text-slate-400 mb-1">ç¦®ç›’</div>
                                            <Tooltip 
                                                title="ç¦®ç›’æç›Šå¹³è¡¡é‡"
                                                items={[
                                                    { label: 'å›ºå®šæˆæœ¬ (MG)', value: formatCurrency(mgTwd) },
                                                    { label: 'æ¯çµ„æ··åˆè²¢ç»', value: formatCurrency(mixContributionValue) },
                                                    { label: 'éœ€éŠ·å”®çµ„æ•¸', value: mixesNeeded },
                                                    { label: 'é…æ¯” (1)', value: 'x 1' },
                                                    { label: 'ç¦®ç›’æ•¸é‡', value: bepGiftQty, isTotal: true }
                                                ]}
                                                formula={`${formatNumber(mgTwd)} / ${formatNumber(mixContributionValue)} * 1 = ${formatNumber(bepGiftQty)}`}
                                            >
                                                {/* ä¿®æ”¹ï¼šåŠ å¤§æ•¸å­—å­—é«” */}
                                                <span className="text-xl font-bold text-white cursor-help border-b border-dotted border-white/30 inline-block">
                                                    {formatNumber(bepGiftQty)}
                                                </span>
                                            </Tooltip>
                                        </div>
                                        
                                        {/* Single */}
                                        <div className="flex flex-col items-center justify-end border-l border-white/10">
                                            {/* ä¿®æ”¹ï¼šåŠ å¤§æ¨™ç±¤å­—é«” */}
                                            <div className="text-xs text-slate-400 mb-1">å–®ç“¶</div>
                                            <Tooltip 
                                                title="å–®ç“¶æç›Šå¹³è¡¡é‡"
                                                items={[
                                                    { label: 'å›ºå®šæˆæœ¬ (MG)', value: formatCurrency(mgTwd) },
                                                    { label: 'æ¯çµ„æ··åˆè²¢ç»', value: formatCurrency(mixContributionValue) },
                                                    { label: 'éœ€éŠ·å”®çµ„æ•¸', value: mixesNeeded },
                                                    { label: 'é…æ¯”', value: `x ${inputs.ratioSingle}` },
                                                    { label: 'å–®ç“¶æ•¸é‡', value: bepSingleQty, isTotal: true }
                                                ]}
                                                formula={`${formatNumber(mgTwd)} / ${formatNumber(mixContributionValue)} * ${inputs.ratioSingle} = ${formatNumber(bepSingleQty)}`}
                                            >
                                                {/* ä¿®æ”¹ï¼šåŠ å¤§æ•¸å­—å­—é«” */}
                                                <span className="text-xl font-bold text-white cursor-help border-b border-dotted border-white/30 inline-block">
                                                    {formatNumber(bepSingleQty)}
                                                </span>
                                            </Tooltip>
                                        </div>

                                        {/* Total */}
                                        <div className="flex flex-col items-center justify-end border-l border-white/10">
                                            {/* ä¿®æ”¹ï¼šåŠ å¤§æ¨™ç±¤å­—é«” */}
                                            <div className="text-xs text-slate-400 mb-1">ç¸½è¨ˆ</div>
                                            <Tooltip 
                                                title="ç¸½æç›Šå¹³è¡¡éŠ·å”®é‡" 
                                                formula={`${formatNumber(bepGiftQty)} (ç¦®ç›’) + ${formatNumber(bepSingleQty)} (å–®ç“¶) = ${formatNumber(bepTotalQty)}`}
                                            >
                                                {/* ä¿®æ”¹ï¼šåŠ å¤§æ•¸å­—å­—é«” */}
                                                <span className="text-xl font-bold text-yellow-400 cursor-help border-b border-dotted border-yellow-400/30 inline-block">
                                                    {formatNumber(bepTotalQty)}
                                                </span>
                                            </Tooltip>
                                        </div>
                                    </div>
                                    )}
                                </div>
                            </div>

                        </div>
                        </div>
                        
                        {/* B. é ä¼°éŠ·é‡ */}
                        <div className="bg-blue-50 p-5 rounded-xl border border-blue-200">
                        <div className="flex justify-between items-center mb-4 border-b border-blue-200 pb-2">
                            <h2 className="text-base font-bold flex items-center gap-2 text-blue-800">
                            <TrendingUp className="w-4 h-4" />
                            é ä¼°éŠ·é‡ (è‡ªå‹•é€£å‹• 1:5)
                            </h2>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                            <label className="block text-xs font-bold text-blue-700 mb-1">ç¦®ç›’æ¬¾æ•¸é‡</label>
                            <input type="number" name="salesGift" value={inputs.salesGift} onChange={handleInputChange} onWheel={handleWheel} placeholder="0" className="w-full p-2 bg-white border border-blue-200 rounded text-center font-bold focus:ring-2 focus:ring-blue-400 outline-none no-spinner" />
                            </div>
                            <div className="relative">
                            <label className="block text-xs font-bold text-blue-700 mb-1">å–®ç“¶æ¬¾æ•¸é‡</label>
                            <input type="number" name="salesSingle" value={inputs.salesSingle} onChange={handleInputChange} onWheel={handleWheel} placeholder="0" className="w-full p-2 bg-white border border-blue-200 rounded text-center font-bold focus:ring-2 focus:ring-blue-400 outline-none no-spinner" />
                            </div>
                        </div>
                        </div>

                        {/* C. P&L æç›Šè¡¨ */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                            <h2 className="font-bold text-slate-700 flex items-center gap-2"><TrendingUp className="w-5 h-5" />é ä¼°æç›Šè¡¨ (P&L)</h2>
                        </div>
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-2">
                            <span className="text-slate-600 font-bold">ç¸½ç‡Ÿæ”¶</span>
                            {/* Tooltip Fix: Complete calculation and items */}
                            <Tooltip 
                                title="ç¸½ç‡Ÿæ”¶è¨ˆç®—" 
                                items={[
                                { label: 'ç¦®ç›’ç‡Ÿæ”¶', value: formatCurrency(inputs.salesGift * inputs.priceGiftSet) },
                                { label: 'å–®ç“¶ç‡Ÿæ”¶', value: formatCurrency(inputs.salesSingle * inputs.priceSingle) }
                                ]}
                                formula={`(${inputs.salesGift}çµ„ * ${inputs.priceGiftSet}) + (${inputs.salesSingle}ç“¶ * ${inputs.priceSingle}) = ${formatNumber(totalRevenue)}`}
                            >
                                <span className="text-xl font-bold text-blue-900 cursor-help">{formatCurrency(totalRevenue)}</span>
                            </Tooltip>
                            </div>
                            <div className="w-full bg-slate-100 h-2 rounded-full mb-6"><div className="bg-blue-500 h-2 rounded-full w-full"></div></div>

                            <div className="space-y-3 mb-6 relative">
                            <div className="absolute left-0 top-0 bottom-0 w-px bg-slate-200"></div>
                            {[
                                { label: 'ç‰©æ–™ç¸½æˆæœ¬ (COGS)', val: totalMaterialCost, color: 'text-slate-700', formula: `ç¦®ç›’ç‰©æ–™${formatNumber(vals.salesGift * unitMaterialCostGift)} + å–®ç“¶ç‰©æ–™${formatNumber(vals.salesSingle * unitMaterialCostSingle)} = ${formatNumber(totalMaterialCost)}` },
                                { label: `é€šè·¯è²»ç”¨ (${vals.channelFeeRate}%)`, val: costChannel, color: 'text-purple-700', formula: `ç¸½ç‡Ÿæ”¶ ${formatNumber(totalRevenue)} * ${vals.channelFeeRate}% = ${formatNumber(costChannel)}` },
                                { label: `é‡‘æµè²»ç”¨ (${vals.paymentFeeRate}%)`, val: costPayment, color: 'text-purple-700', formula: `ç¸½ç‡Ÿæ”¶ ${formatNumber(totalRevenue)} * ${vals.paymentFeeRate}% = ${formatNumber(costPayment)}` },
                                { label: `è¡ŒéŠ·è²»ç”¨ (${vals.marketingFeeRate}%)`, val: costMarketing, color: 'text-purple-700', formula: `ç¸½ç‡Ÿæ”¶ ${formatNumber(totalRevenue)} * ${vals.marketingFeeRate}% = ${formatNumber(costMarketing)}` },
                                { label: `ç‡Ÿæ¥­ç¨… (${vals.taxEnabled ? '5%' : 'Off'})`, val: costTax, color: 'text-slate-500', formula: `ç¸½ç‡Ÿæ”¶ ${formatNumber(totalRevenue)} * ${vals.taxEnabled ? 5 : 0}% = ${formatNumber(costTax)}` },
                            ].map((row, idx) => (
                                <div key={idx} className="flex justify-between items-center text-sm pl-4 relative group">
                                <div className="absolute left-0 top-1/2 w-2 h-px bg-slate-300"></div>
                                <span className="text-slate-500">{row.label}</span>
                                <Tooltip 
                                    title={row.label} 
                                    items={[{ label: 'è¨ˆç®—çµæœ', value: formatCurrency(row.val), isTotal: true }]}
                                    formula={row.formula}
                                >
                                    <span className={`font-mono ${row.color} cursor-help`}>- {formatCurrency(row.val)}</span>
                                </Tooltip>
                                </div>
                            ))}
                            <div className={`flex justify-between items-center text-sm p-2 rounded ml-4 ${isOverMg ? 'bg-green-50 text-green-800' : 'bg-orange-50 text-orange-800'}`}>
                                <div className="flex flex-col">
                                <span className="font-bold flex items-center gap-1">æˆæ¬Šé‡‘ {isOverMg ? <span className="text-[10px] bg-green-200 px-1 rounded">å·²è¶…ä¿åº•</span> : <span className="text-[10px] bg-orange-200 px-1 rounded">æœªé”ä¿åº•</span>}</span>
                                </div>
                                {/* Tooltip Fix: Royalty Calculation */}
                                <Tooltip 
                                title="æˆæ¬Šé‡‘è¨ˆç®—" 
                                items={[
                                    { label: 'ä¿åº•é‡‘é¡ (MG)', value: formatCurrency(mgTwd) },
                                    { label: 'æ¥­ç¸¾æŠ½æˆ', value: formatCurrency(totalRevenue * inputs.royaltyRate / 100) },
                                    { label: 'å¯¦éš›æ”¯ä»˜', value: formatCurrency(finalLicensingCost), isTotal: true }
                                ]}
                                formula={`Max(MG ${formatNumber(mgTwd)}, ç‡Ÿæ”¶*${inputs.royaltyRate}%) = ${formatNumber(finalLicensingCost)}`}
                                >
                                <span className="font-mono font-bold cursor-help">- {formatCurrency(finalLicensingCost)}</span>
                                </Tooltip>
                            </div>
                            <div className="flex justify-between items-center text-sm font-bold border-t pt-2 pl-4 text-slate-600">
                                <span>ç¸½æˆæœ¬ (Total Cost)</span>
                                {/* Tooltip Fix: Total Cost */}
                                <Tooltip 
                                title="å°ˆæ¡ˆç¸½æˆæœ¬" 
                                items={[
                                    { label: 'ç¸½ç‰©æ–™', value: formatCurrency(totalMaterialCost) },
                                    { label: 'ç¸½ç‡Ÿé‹(å«ç¨…/æˆæ¬Š)', value: formatCurrency(totalOpEx) }
                                ]}
                                formula={`ç‰©æ–™ ${formatNumber(totalMaterialCost)} + ç‡Ÿé‹ ${formatNumber(totalOpEx)} = ${formatNumber(totalProjectCost)}`}
                                >
                                <span className="cursor-help">- {formatCurrency(totalProjectCost)}</span>
                                </Tooltip>
                            </div>
                            </div>

                            <div className={`p-4 rounded-xl border-2 flex justify-between items-center ${netProfit >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                            <div>
                                <div className={`${netProfit >= 0 ? 'text-green-700' : 'text-red-700'} font-bold text-lg`}>{inputs.taxEnabled ? 'ç¨…å¾Œæ·¨åˆ©' : 'ç¨…å‰æ·¨åˆ©'} (Net Profit)</div>
                                <div className={`${netProfit >= 0 ? 'text-green-600' : 'text-red-600'} text-sm`}>æ·¨åˆ©ç‡: {netProfitMargin.toFixed(1)}%</div>
                            </div>
                            {/* Tooltip Fix: Net Profit */}
                            <Tooltip 
                                title="æ·¨åˆ©é©—ç®—" 
                                items={[
                                { label: 'ç¸½ç‡Ÿæ”¶', value: formatCurrency(totalRevenue) },
                                { label: 'ç¸½æˆæœ¬', value: formatCurrency(totalProjectCost) },
                                { label: 'æ·¨åˆ©', value: formatCurrency(netProfit), isTotal: true }
                                ]}
                                formula={`ç¸½ç‡Ÿæ”¶ ${formatNumber(totalRevenue)} - ç¸½æˆæœ¬ ${formatNumber(totalProjectCost)} = ${formatNumber(netProfit)}`}
                            >
                                <div className={`${netProfit >= 0 ? 'text-green-800' : 'text-red-800'} text-3xl font-bold cursor-help`}>{formatCurrency(netProfit)}</div>
                            </Tooltip>
                            </div>
                            
                            {/* åŒ¯å‡ºæŒ‰éˆ• */}
                            <div className="mt-6 flex justify-end">
                            <button 
                                onClick={handleExport}
                                className="flex items-center gap-2 bg-blue-900 hover:bg-blue-800 text-white px-5 py-3 rounded-lg font-bold shadow-lg transition-all active:scale-95"
                            >
                                <Download className="w-5 h-5" />
                                ä¸€éµè¼¸å‡º EXCEL (.csv)
                            </button>
                            </div>

                        </div>
                        </div>

                    </div>
                    </div>
                    
                    {/* Footer */}
                    <footer className="mt-12 py-6 border-t border-slate-200 text-center text-slate-400 text-xs space-y-2">
                    <div className="font-medium">Powered by IP å¤§ç¥å·¥å…·åŒ…</div>
                    <div className="flex items-center justify-center gap-1">
                        Copyright Â© 2026 
                        <a 
                        href="https://weido.biz/" 
                        target="_blank" 
                        rel="noopener noreferrer" 
                        className="hover:text-blue-500 transition-colors flex items-center gap-0.5"
                        >
                        IP Ark
                        <ExternalLink className="w-3 h-3" />
                        </a> 
                        ç‰ˆæ¬Šæ‰€æœ‰
                    </div>
                    </footer>

                </div>
                </div>
            );
        };

        const App = () => {
            const [isUnlocked, setIsUnlocked] = useState(false);
            
            if (!isUnlocked) {
                return <LockScreen onUnlock={() => setIsUnlocked(true)} />;
            }
            
            return <MainApp />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
